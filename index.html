<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººæˆé•·å­¸ç¿’è»Œè·¡ App - æ—¥ç³»æ¥µç°¡é¢¨ (v4.0 ç²¾ç°¡ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* æ—¥ç³»æ¥µç°¡é¢¨å­—é«”ï¼šä½¿ç”¨ç³»çµ±é è¨­çš„ç„¡è¥¯ç·šå­—é«”ï¼Œç¢ºä¿æ¸…æ™°åº¦ */
        body {
            font-family: 'Inter', 'Noto Sans TC', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #fcfbf8; /* æ•´é«”èƒŒæ™¯ï¼šç±³ç™½è‰²èª¿å»¶ä¼¸ */
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ (åƒ…é©ç”¨æ–¼æ¡Œé¢) */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #d7b57a; border-radius: 2px; }
        ::-webkit-scrollbar-track { background: #fcfbf8; }

        /* é é¦–åœ“å¼§éŠœæ¥æ•ˆæœ */
        .header-curve-mask {
            position: relative;
            z-index: 10;
            margin-top: -50px;
            padding-top: 50px;
            border-top-left-radius: 40px;
            border-top-right-radius: 40px;
            background-color: #ffffff;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
        }

        /* åº•éƒ¨å°èˆªæ¬„ */
        .bottom-nav {
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.vueApp.userId = user.uid;
                } else if (initialAuthToken) {
                    try { await signInWithCustomToken(window.auth, initialAuthToken); } catch (error) { await signInAnonymously(window.auth); }
                } else { await signInAnonymously(window.auth); }
                window.vueApp.isAuthReady = true;
            });
            window.dbFunctions = { doc, collection, query, onSnapshot, addDoc, updateDoc, serverTimestamp };
        } else {
            console.error("Firebase é…ç½®æœªè¼‰å…¥ã€‚App å°‡ä»¥æ¨¡æ“¬æ¨¡å¼é‹è¡Œ (ç„¡æ³•æŒä¹…å„²å­˜è³‡æ–™)ã€‚");
            window.vueApp.isAuthReady = true;
        }
    </script>
</head>
<body class="antialiased min-h-screen">
    <div id="app" class="max-w-xl mx-auto min-h-screen bg-stone-50 pb-20"> <header class="h-[250px] relative overflow-hidden bg-amber-100">
            <img src="https://placehold.co/1920x400/fff3e0/fff"
                 alt="å¯æ„›æ‰‹ç¹ªå­¸ç¿’è¨ˆç•«æ’ç•«"
                 class="absolute inset-0 w-full h-full object-cover opacity-80"
                 onerror="this.onerror=null;this.src='https://placehold.co/1920x400/fff3e0/fff'">

            <div class="absolute top-0 left-0 right-0 p-4 text-stone-800 text-center font-bold text-2xl z-20 opacity-80">
                ğŸš€ å€‹äººæˆé•·è»Œè·¡
            </div>

            <div class="absolute bottom-0 left-0 right-0 h-16 bg-stone-50"
                 style="border-top-left-radius: 40px; border-top-right-radius: 40px; transform: translateY(40px);">
            </div>
        </header>

        <main class="p-4 relative bg-white header-curve-mask min-h-[calc(100vh-250px)]">

            <div v-show="activeTab === 'daily'" class="pt-2">
                <h2 class="text-2xl font-bold mb-4 text-stone-800">ğŸ“… {{ formatDate(currentDate, 'MMæœˆDDæ—¥') }} èª²è¡¨</h2>

                <div class="flex space-x-2 overflow-x-auto pb-4 sticky top-0 bg-white z-20 shadow-sm border-b">
                    <div v-for="day in dateRange" :key="day.dateString"
                         @click="selectDate(day.date)"
                         :class="['flex-shrink-0 w-16 h-16 rounded-xl p-1 text-center cursor-pointer transition',
                                   day.isToday ? 'bg-amber-100 shadow-md border-2 border-amber-300' : 'bg-stone-50',
                                   day.isSelected ? 'bg-amber-400 text-white font-bold transform scale-105' : 'text-stone-700']">
                        <div class="text-xs opacity-70">{{ day.dayOfWeek }}</div>
                        <div class="text-2xl leading-none font-bold">{{ day.dayOfMonth }}</div>
                    </div>
                </div>

                <div class="my-4">
                    <select v-model="selectedCourseFilter"
                            class="w-full p-3 rounded-xl border border-stone-200 bg-stone-50 text-stone-700 text-sm focus:ring-amber-400 focus:border-amber-400">
                        <option value="All">æ‰€æœ‰ä»»å‹™</option>
                        <option v-for="course in courses" :value="course.id" :key="course.id">
                            {{ course.name }}
                        </option>
                    </select>
                </div>

                <div v-if="filteredTasks.length" class="space-y-3">
                    <div v-for="(task, index) in filteredTasks" :key="task.id"
                         :class="['p-4 rounded-xl shadow-md border-l-4 transition duration-300',
                                   task.completed ? 'bg-stone-100 border-green-400 opacity-70' : 'bg-white border-amber-400']">
                        <div class="flex items-center justify-between mb-2 text-stone-400 text-xs">
                            <span>èª²ç¨‹ {{ task.courseId }}</span>
                            <i class="ph ph-dots-three-vertical cursor-grab"></i>
                        </div>

                        <div class="flex items-center justify-between">
                            <div :class="['flex-1 mr-4', task.completed ? 'line-through text-stone-500' : 'text-stone-800']">
                                <p class="font-semibold text-lg">{{ task.content }}</p>
                            </div>

                            <div class="flex items-center space-x-3">
                                <input type="checkbox" :checked="task.completed"
                                       @change="toggleTaskCompletion(task.id, $event.target.checked)"
                                       class="h-6 w-6 text-green-600 rounded border-stone-300 focus:ring-green-500 cursor-pointer flex-shrink-0">
                            </div>
                        </div>

                        <div class="mt-3 border-t pt-3 flex justify-start items-center text-sm">
                            <span v-if="task.completed" class="text-xs text-green-600 font-medium">
                                ä»»å‹™å·²å®Œæˆ âœ…
                            </span>
                             <span v-else class="text-xs text-stone-400">
                                å¾…åŸ·è¡Œ
                            </span>
                        </div>
                    </div>
                </div>
                <div v-else class="p-6 text-center text-stone-500 bg-stone-100 rounded-xl mt-6">
                    <i class="ph ph-calendar-blank text-3xl mb-2"></i>
                    <p>æœ¬æ—¥ç„¡æ’ç¨‹ä»»å‹™ï¼Œé»æ“Šå³ä¸‹è§’ '+' æ–°å¢ã€‚</p>
                </div>

                <div class="mt-8">
                    <details class="rounded-xl bg-stone-50 p-4 border border-stone-200" :open="!!dailyReflection.content">
                        <summary class="font-semibold text-stone-700 cursor-pointer">
                            ğŸ“ ä»Šæ—¥å¿ƒå¾—èˆ‡åæ€
                        </summary>
                        <textarea rows="4" placeholder="è¼¸å…¥æ‚¨ä»Šæ—¥çš„åæ€ã€æŒ‘æˆ°æˆ–çªç ´..."
                                  v-model="dailyReflection.content"
                                  class="w-full mt-3 p-3 text-sm rounded-lg border border-stone-300 focus:ring-amber-400 focus:border-amber-400"></textarea>
                        <button @click="saveDailyReflection" class="w-full mt-2 py-2 bg-stone-700 text-white rounded-lg hover:bg-stone-800 transition">
                            å„²å­˜å¿ƒå¾—
                        </button>
                    </details>
                </div>
            </div>

            <div v-show="activeTab === 'overview'" class="pt-2">
                <h2 class="text-2xl font-bold mb-4 text-stone-800">ğŸ“š èª²ç¨‹ç¸½è¦½</h2>

                <div class="space-y-6">
                    <div v-for="course in courses" :key="course.id"
                         class="p-5 bg-white rounded-xl shadow-lg border-l-4 border-amber-500 transition hover:shadow-xl hover:scale-[1.01]">
                        
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-stone-800 mb-1">{{ course.name }} (èª²ç¨‹ {{ course.id }})</h3>
                            <button @click="toggleEditCourse(course.id)" class="text-stone-500 hover:text-amber-600 p-1 -mt-1 -mr-1">
                                <i :class="['ph text-xl', course.isEditing ? 'ph-check-square-fill text-green-600' : 'ph-pencil-simple-fill']"></i>
                            </button>
                        </div>
                        

                        <div class="text-sm text-stone-600 mb-2 mt-2">
                            <span class="font-semibold text-amber-700">ç›®æ¨™:</span>
                            <template v-if="course.isEditing">
                                <input type="text" v-model="course.goal" @keyup.enter="toggleEditCourse(course.id)"
                                       class="w-full mt-1 p-2 border rounded-lg focus:ring-amber-400 focus:border-amber-400">
                            </template>
                            <span v-else>{{ course.goal }}</span>
                        </div>

                        <div class="text-sm text-stone-600 mb-3">
                            <span class="font-semibold text-amber-700">æˆæœ:</span>
                            <template v-if="course.isEditing">
                                <input type="text" v-model="course.outcome" @keyup.enter="toggleEditCourse(course.id)"
                                       class="w-full mt-1 p-2 border rounded-lg focus:ring-amber-400 focus:border-amber-400">
                            </template>
                            <span v-else>{{ course.outcome }}</span>
                        </div>

                        <div class="w-full bg-stone-200 rounded-full h-2.5 mt-3">
                            <div class="h-2.5 rounded-full bg-amber-500 transition-all duration-500"
                                 :style="{ width: courseProgress[course.id] + '%' }"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1 text-stone-500">
                            <span>å·²å®Œæˆ: {{ course.completedCount }} / {{ course.totalTasks }}</span>
                            <span class="font-bold text-amber-700">{{ courseProgress[course.id] }}%</span>
                        </div>
                    </div>
                </div>
                
            </div>

            <div v-show="activeTab === 'monthly'" class="pt-2">
                <h2 class="text-2xl font-bold mb-4 text-stone-800">ğŸ—“ï¸ {{ formatDate(currentMonth, 'YYYYå¹´MMæœˆ') }} æ¦‚è¦½</h2>

                <div class="flex justify-between items-center mb-4">
                    <button @click="navigateMonth(-1)" class="p-2 text-stone-600 hover:bg-stone-100 rounded-full transition">
                        <i class="ph ph-caret-left text-xl"></i>
                    </button>
                    <span class="text-xl font-bold text-amber-600">{{ formatDate(currentMonth, 'YYYYå¹´MMæœˆ') }}</span>
                    <button @click="navigateMonth(1)" class="p-2 text-stone-600 hover:bg-stone-100 rounded-full transition">
                        <i class="ph ph-caret-right text-xl"></i>
                    </button>
                </div>

                <div class="grid grid-cols-7 text-center text-sm font-semibold text-stone-500 mb-2">
                    <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
                </div>

                <div class="grid grid-cols-7 gap-1">
                    <div v-for="(day, index) in monthlyView" :key="index"
                         @click="selectDayFromMonthly(day)"
                         :class="['h-16 p-1 rounded-lg text-center transition cursor-pointer',
                                   day.isCurrentMonth ? 'text-stone-800' : 'text-stone-300 pointer-events-none',
                                   day.isToday ? 'bg-amber-100 border-2 border-amber-400' : 'bg-stone-50',
                                   day.isSelected ? 'bg-amber-400 text-white font-bold' : '',
                                   day.courseNames.length && !day.isSelected ? 'shadow-sm border border-stone-200' : '']">

                        <div class="text-lg leading-none font-bold">{{ day.day }}</div>

                        <div v-if="day.courseNames.length" class="mt-1 flex justify-center flex-wrap gap-1 max-h-5 overflow-hidden">
                            <span v-for="(name, idx) in day.courseNames.slice(0, 2)" :key="idx"
                                  :class="['text-[8px] leading-none px-1 rounded-sm whitespace-nowrap', day.isSelected ? 'bg-white text-amber-500' : 'bg-amber-500 text-white']">
                                {{ name }}
                            </span>
                            <span v-if="day.courseNames.length > 2"
                                  :class="['text-[8px] leading-none px-1 rounded-sm whitespace-nowrap', day.isSelected ? 'bg-white text-amber-500' : 'bg-stone-700 text-white']">
                                +{{ day.courseNames.length - 2 }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
        </main>

        <button @click="openModal('NewTask')"
                class="fixed bottom-24 right-6 w-14 h-14 bg-amber-500 hover:bg-amber-600 text-white rounded-full flex items-center justify-center text-3xl shadow-xl transition transform hover:scale-110 z-40">
            <i class="ph ph-plus"></i>
        </button>

        <nav class="bottom-nav fixed bottom-0 left-0 right-0 max-w-xl mx-auto bg-white border-t border-stone-100 flex justify-around items-center h-20 z-30">
            <div v-for="tab in tabs" :key="tab.id"
                 @click="activeTab = tab.id"
                 :class="['flex flex-col items-center p-2 transition cursor-pointer',
                           activeTab === tab.id ? 'text-amber-500 font-bold' : 'text-stone-500 hover:text-stone-700']">
                <i :class="['ph text-2xl', tab.icon]"></i>
                <span class="text-xs mt-1">{{ tab.name }}</span>
            </div>
        </nav>

        <div v-if="modal.isVisible" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-md p-6 relative">
                <h3 class="text-xl font-bold mb-4 text-stone-800">æ–°å¢ä»»å‹™</h3>

                <div class="space-y-3">
                    <input type="text" placeholder="ä»»å‹™å…§å®¹ (e.g., é–±è®€ Chapter 5)"
                           v-model="newTask.content"
                           class="w-full p-3 rounded-lg border border-stone-300 focus:ring-amber-400 focus:border-amber-400">
                    <select v-model="newTask.courseId"
                            class="w-full p-3 rounded-lg border border-stone-300 focus:ring-amber-400 focus:border-amber-400">
                        <option :value="null">é¸æ“‡æ‰€å±¬èª²ç¨‹</option>
                        <option v-for="course in courses" :value="course.id" :key="course.id">{{ course.name }}</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="closeModal" class="px-4 py-2 text-stone-600 rounded-lg hover:bg-stone-100 transition">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveTask" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition">
                        å„²å­˜ä»»å‹™
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        window.vueApp = new Vue({
            el: '#app',
            data: {
                isAuthReady: false,
                userId: null,
                activeTab: 'daily',
                currentDate: new Date(),
                currentMonth: new Date(),
                selectedCourseFilter: 'All',
                detailCourse: null,
                dailyReflections: {}, // { 'YYYY-MM-DD': 'å¿ƒå¾—å…§å®¹' }
                
                // Req 3: ç§»é™¤ 'drafts' å’Œ 'resources'
                tabs: [
                    { id: 'daily', name: 'æ¯æ—¥èª²è¡¨', icon: 'ph-calendar-blank-fill' },
                    { id: 'overview', name: 'èª²ç¨‹ç¸½è¦½', icon: 'ph-books-fill' },
                    { id: 'monthly', name: 'æ¯æœˆæ¦‚è¦½', icon: 'ph-calendar-fill' },
                ],
                
                // è³‡æ–™æ¨¡å‹ (èª²ç¨‹æ–°å¢ isEditing ç‹€æ…‹)
                courses: [
                    { id: 1, name: 'å¿ƒç†æˆé•·èˆ‡ç¿’æ…£é¤Šæˆ', shortName: 'å¿ƒç†æˆé•·', isEditing: false, goal: 'æŒæ¡æƒ…ç·’èª¿é©èˆ‡é«˜ç”Ÿç”¢åŠ›ç¿’æ…£', outcome: 'æ¯æ—¥åæ€æ—¥è¨˜ã€è¡Œå‹•æ¸…å–®', totalTasks: 18, completedCount: 12, learningContent: [{ id: 'A', name: 'ç„¦æ…®ä¸‰å•ç·´ç¿’' }] },
                    { id: 2, name: 'é‡‘èèˆ‡ AI å°ˆæ¥­æŠ€èƒ½', shortName: 'é‡‘èAI', isEditing: false, goal: 'æ‡‰ç”¨ GenAI æå‡é‡‘èæ±ºç­–æ•ˆç‡', outcome: 'ä¸‰ä»½å¸‚å ´åˆ†æå ±å‘Š', totalTasks: 25, completedCount: 5, learningContent: [{ id: 'C', name: 'å­¸ç¿’ Python é‡‘èå¥—ä»¶' }] },
                    { id: 3, name: 'è²¡å‹™è¦åŠƒèˆ‡æŠ•è³‡çµ„åˆ', shortName: 'è²¡å‹™è¦åŠƒ', isEditing: false, goal: 'å»ºç«‹ä¸¦è¿½è¹¤ç©©å¥çš„è²¡å‹™æ¨¡å‹', outcome: 'å­£åº¦è³‡ç”¢å ±å‘Š', totalTasks: 15, completedCount: 8, learningContent: [{ id: 'E', name: 'é–±è®€ã€Šå¯Œçˆ¸çˆ¸çª®çˆ¸çˆ¸ã€‹' }] },
                    { id: 4, name: 'è‹±èªæºé€šèˆ‡è¡¨é”', shortName: 'è‹±èªæºé€š', isEditing: false, goal: 'èƒ½æµæš¢é€²è¡Œå¤–å•†æœƒè­°èˆ‡ç°¡å ±', outcome: 'ä¸‰æ¬¡å¤–å•†æ¨¡æ“¬æœƒè­°éŒ„éŸ³', totalTasks: 30, completedCount: 20, learningContent: [{ id: 'F', name: 'ç·´ç¿’ä¸»é¡Œ M ç°¡å ±' }] },
                    { id: 5, name: 'å…§å®¹å‰µä½œèˆ‡å€‹äººå“ç‰Œ', shortName: 'å…§å®¹å‰µä½œ', isEditing: false, goal: 'æ¯é€±ç”¢å‡ºé«˜å“è³ªçš„çŸ¥è­˜å…§å®¹', outcome: 'åç¯‡éƒ¨è½æ ¼è‰ç¨¿', totalTasks: 12, completedCount: 4, learningContent: [{ id: 'G', name: 'ç™¼æƒ³ä¸»é¡Œ Q' }] },
                    { id: 6, name: 'ç”Ÿæ´»ç¾æ„Ÿèˆ‡é«”é©—', shortName: 'ç”Ÿæ´»ç¾æ„Ÿ', isEditing: false, goal: 'æå‡ç”Ÿæ´»å“è³ªèˆ‡éˆæ„Ÿæ•æ‰èƒ½åŠ›', outcome: 'ç…§ç‰‡éˆæ„Ÿé›†ã€æ·±åº¦é«”é©—ç´€éŒ„', totalTasks: 10, completedCount: 10, learningContent: [{ id: 'P', name: 'ç´€éŒ„ç”Ÿæ´»éˆæ„Ÿ' }] },
                ],
                tasks: [],
                // drafts: [], // ç§»é™¤
                // resources: [], // ç§»é™¤
                
                newTask: { content: '', courseId: null, },
                
                modal: { isVisible: false, mode: 'NewTask', data: {} }
            },
            computed: {
                dailyReflection: {
                    get() {
                        const dateKey = this.formatDate(this.currentDate, 'YYYY-MM-DD');
                        return { content: this.dailyReflections[dateKey] || '' };
                    },
                    set(newValue) {
                        const dateKey = this.formatDate(this.currentDate, 'YYYY-MM-DD');
                        this.$set(this.dailyReflections, dateKey, newValue.content);
                    }
                },
                dateRange() {
                    const days = [];
                    const today = this.formatDate(new Date(), 'YYYY-MM-DD');
                    for (let i = -3; i <= 3; i++) {
                        const date = new Date(this.currentDate); 
                        date.setDate(this.currentDate.getDate() + i);
                        const dateString = this.formatDate(date, 'YYYY-MM-DD');
                        days.push({
                            date: date,
                            dateString: dateString,
                            dayOfWeek: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()],
                            dayOfMonth: date.getDate(),
                            isToday: dateString === today,
                            isSelected: this.formatDate(this.currentDate, 'YYYY-MM-DD') === dateString
                        });
                    }
                    return days;
                },
                filteredTasks() {
                    const selectedDate = this.formatDate(this.currentDate, 'YYYY-MM-DD');
                    return this.tasks
                        .filter(task => this.formatDate(task.date, 'YYYY-MM-DD') === selectedDate)
                        .filter(task => this.selectedCourseFilter === 'All' || task.courseId === parseInt(this.selectedCourseFilter));
                },
                // ç§»é™¤ totalCompletedCount (Req 1)
                courseProgress() {
                    const progress = {};
                    this.courses.forEach(course => {
                        if (course.totalTasks === 0) {
                            progress[course.id] = 0;
                        } else {
                            progress[course.id] = Math.floor((course.completedCount / course.totalTasks) * 100);
                        }
                    });
                    return progress;
                },
                // Req 4: æœˆä»½æ¦‚è¦½è¨ˆç®— (é¡¯ç¤ºèª²ç¨‹åç¨±ç¸®å¯«)
                monthlyView() {
                    const month = this.currentMonth.getMonth();
                    const year = this.currentMonth.getFullYear();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const numDays = lastDay.getDate();

                    let startDayOfWeek = firstDay.getDay();

                    const calendar = [];
                    const tasksByDate = {}; // { 'YYYY-MM-DD': [èª²ç¨‹åç¨±ç¸®å¯«é™£åˆ—] }

                    // 1. å»ºç«‹æ—¥æœŸ -> èª²ç¨‹åç¨±ç¸®å¯« æ˜ å°„
                    const courseMap = this.courses.reduce((map, course) => {
                        map[course.id] = course.shortName;
                        return map;
                    }, {});

                    this.tasks.forEach(t => {
                        const dateString = this.formatDate(t.date, 'YYYY-MM-DD');
                        const courseShortName = courseMap[t.courseId];
                        if (courseShortName) {
                            if (!tasksByDate[dateString]) {
                                tasksByDate[dateString] = new Set();
                            }
                            tasksByDate[dateString].add(courseShortName);
                        }
                    });

                    // å¡«å……ä¸Šå€‹æœˆçš„æ—¥æœŸ
                    for (let i = 0; i < startDayOfWeek; i++) {
                        calendar.push({ day: null, isCurrentMonth: false, courseNames: [] });
                    }

                    // å¡«å……æœ¬æœˆçš„æ—¥æœŸ
                    for (let i = 1; i <= numDays; i++) {
                        const date = new Date(year, month, i);
                        const dateString = this.formatDate(date, 'YYYY-MM-DD');
                        const courseNames = tasksByDate[dateString] ? Array.from(tasksByDate[dateString]) : [];

                        calendar.push({
                            day: i,
                            date: date,
                            dateString: dateString,
                            isCurrentMonth: true,
                            isSelected: dateString === this.formatDate(this.currentDate, 'YYYY-MM-DD'),
                            isToday: dateString === this.formatDate(new Date(), 'YYYY-MM-DD'),
                            courseNames: courseNames, // èª²ç¨‹åç¨±ç¸®å¯«é™£åˆ—
                        });
                    }

                    // å¡«å……ä¸‹å€‹æœˆçš„æ—¥æœŸ
                    while (calendar.length % 7 !== 0) {
                        calendar.push({ day: null, isCurrentMonth: false, courseNames: [] });
                    }

                    return calendar;
                },
            },
            watch: {
                isAuthReady(isReady) {
                    if (isReady && this.userId) {
                        this.fetchData('tasks');
                        this.fetchData('reflections'); 
                    }
                }
            },
            methods: {
                formatDate(date, format) {
                    if (!date) return '';
                    const d = date instanceof Date ? date : (date.toDate ? date.toDate() : new Date(date));
                    const pad = (n) => (n < 10 ? '0' + n : n);
                    let str = format;
                    str = str.replace('YYYY', d.getFullYear());
                    str = str.replace('MM', pad(d.getMonth() + 1));
                    str = str.replace('DD', pad(d.getDate()));
                    str = str.replace('HH', pad(d.getHours()));
                    str = str.replace('mm', pad(d.getMinutes()));
                    return str;
                },
                selectDate(date) {
                    this.currentDate = date;
                },
                saveDailyReflection() {
                    const dateKey = this.formatDate(this.currentDate, 'YYYY-MM-DD');
                    const content = this.dailyReflection.content;
                    if (content.trim() === '') {
                        delete this.dailyReflections[dateKey];
                        localStorage.removeItem(`reflection-${dateKey}`);
                        alert('å¿ƒå¾—å·²æ¸…é™¤ã€‚');
                    } else {
                        this.$set(this.dailyReflections, dateKey, content);
                        localStorage.setItem(`reflection-${dateKey}`, content);
                        alert('å¿ƒå¾—å·²å„²å­˜ï¼');
                    }
                },
                openModal(mode, data = {}) {
                    this.modal.mode = mode;
                    this.modal.data = data;
                    this.modal.isVisible = true;
                },
                closeModal() {
                    this.modal.isVisible = false;
                    this.modal.data = {};
                    this.newTask = { content: '', courseId: null };
                },
                // Req 2: åˆ‡æ›ç›®æ¨™/æˆæœçš„ç·¨è¼¯æ¨¡å¼
                toggleEditCourse(courseId) {
                    const course = this.courses.find(c => c.id === courseId);
                    if (course) {
                        // æ¨¡æ“¬å„²å­˜ (å¦‚æœé€²å…¥ç·¨è¼¯æ¨¡å¼ï¼Œä¸‹æ¬¡é»æ“Šå°±æ˜¯å„²å­˜)
                        if (course.isEditing) {
                            // åœ¨é€™è£¡å¯ä»¥åŠ å…¥ Firebase æˆ– LocalStorage çš„å„²å­˜é‚è¼¯
                            console.log(`èª²ç¨‹ ${courseId} ç›®æ¨™/æˆæœå·²å„²å­˜ã€‚`);
                        }
                        course.isEditing = !course.isEditing;
                    }
                },
                fetchData(collectionName) {
                    if (collectionName === 'reflections') {
                         // æ¨¡æ“¬å¾ LocalStorage è¼‰å…¥å¿ƒå¾—
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('reflection-')) {
                                const dateKey = key.replace('reflection-', '');
                                const content = localStorage.getItem(key);
                                this.$set(this.dailyReflections, dateKey, content);
                            }
                        }
                        return;
                    }
                    if (!window.dbFunctions || !this.userId) return;
                    // ... Firebase æ•¸æ“šè¼‰å…¥é‚è¼¯ (ä¿æŒä¸è®Š)
                },
                async saveTask() {
                    if (!this.newTask.content || !this.newTask.courseId) {
                        alert('è«‹è¼¸å…¥ä»»å‹™å…§å®¹ä¸¦é¸æ“‡æ‰€å±¬èª²ç¨‹ï¼');
                        return;
                    }
                    const taskData = {
                        date: this.currentDate,
                        courseId: parseInt(this.newTask.courseId),
                        content: this.newTask.content,
                        completed: false,
                        createdAt: window.dbFunctions ? window.dbFunctions.serverTimestamp() : new Date(),
                    };

                    if (window.dbFunctions && this.userId) {
                        // ... Firebase å„²å­˜é‚è¼¯ (ä¿æŒä¸è®Š)
                    } else {
                        // æ¨¡æ“¬ Local å„²å­˜
                        this.tasks.push({ id: `t${Date.now()}`, ...taskData });
                    }
                    this.closeModal();
                },
                async toggleTaskCompletion(taskId, isCompleted) {
                    if (!window.dbFunctions || !this.userId) {
                         const task = this.tasks.find(t => t.id === taskId);
                         if (task) {
                            task.completed = isCompleted;
                            task.completedAt = isCompleted ? new Date() : null;
                         }
                         const taskToUpdate = this.tasks.find(t => t.id === taskId);
                         if (taskToUpdate) {
                             const course = this.courses.find(c => c.id === taskToUpdate.courseId);
                             if (course) {
                                course.completedCount += isCompleted ? 1 : -1;
                             }
                         }
                         return;
                    }

                    // ... Firebase é‚è¼¯ (ä¿æŒä¸è®Š)
                },
                // æœˆæ›†åˆ‡æ›æœˆä»½
                navigateMonth(offset) {
                    const newDate = new Date(this.currentMonth);
                    newDate.setMonth(newDate.getMonth() + offset);
                    this.currentMonth = newDate;
                },
                // å¾æœˆæ›†è¦–åœ–é»æ“Šæ—¥æœŸ
                selectDayFromMonthly(day) {
                    if (day.date) {
                        this.currentDate = day.date;
                        this.activeTab = 'daily';
                    }
                }
            },
            created() {
                if (!window.firebaseApp) {
                    // æ¨¡æ“¬æ•¸æ“š
                    this.tasks = [
                        { id: 't1', date: new Date(), courseId: 1, content: 'è®€ã€ŠThe Mountain Is Youã€‹', completed: true, completedAt: new Date(new Date().setHours(8, 0, 0)) },
                        { id: 't2', date: new Date(), courseId: 2, content: 'æ’°å¯« AI å ±å‘Šè‰ç¨¿', completed: false },
                        { id: 't3', date: new Date(), courseId: 6, content: 'è¨˜éŒ„ç”Ÿæ´»éˆæ„Ÿ P', completed: false },
                        { id: 't4', date: new Date(new Date().setDate(new Date().getDate() + 1)), courseId: 3, content: 'å»ºç«‹ Q3 è²¡å‹™æ¨¡å‹', completed: false },
                        { id: 't5', date: new Date(new Date().setDate(new Date().getDate() - 2)), courseId: 4, content: 'ç·´ç¿’ä¸»é¡Œ M ç°¡å ±', completed: true, completedAt: new Date(new Date().setHours(14, 30, 0)) },
                        { id: 't6', date: new Date(), courseId: 1, content: 'æ—©ä¸Šå†¥æƒ³ 10 åˆ†é˜', completed: true, completedAt: new Date(new Date().setHours(7, 0, 0)) },
                        { id: 't7', date: new Date(new Date().setDate(new Date().getDate() - 15)), courseId: 5, content: 'ç™¼æƒ³ä¸»é¡Œ Q', completed: false },
                        { id: 't8', date: new Date(new Date().setDate(new Date().getDate() - 15)), courseId: 2, content: 'å­¸ç¿’ Python é‡‘èå¥—ä»¶', completed: true },
                        { id: 't9', date: new Date(new Date().setDate(new Date().getDate() - 15)), courseId: 4, content: 'æ¨¡æ“¬å¤–å•†æœƒè­°', completed: true },
                        { id: 't10', date: new Date(new Date().setDate(new Date().getDate() - 5)), courseId: 1, content: 'ç„¦æ…®ä¸‰å•ç·´ç¿’', completed: true },
                        { id: 't11', date: new Date(new Date().setDate(new Date().getDate() - 5)), courseId: 4, content: 'é–±è®€è‹±æ–‡æ–°è', completed: true },
                        { id: 't12', date: new Date(new Date().setDate(new Date().getDate() - 5)), courseId: 5, content: 'æ–‡ç« å¤§ç¶±ç¢ºç«‹', completed: false },
                        { id: 't13', date: new Date(new Date().setDate(new Date().getDate() - 5)), courseId: 2, content: 'AI èªç¾©åˆ†æ', completed: true },
                    ];
                    this.fetchData('reflections');
                }
            }
        });
    </script>
</body>
</html>