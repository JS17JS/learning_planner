<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººå­¸ç¿’èª²ç¶±è¦åŠƒ App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* åŸºç¤æ¨£å¼ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px;
            border-left: 1px solid #e5e7eb;
            border-top: 1px solid #e5e7eb;
        }
        .day-cell {
            min-height: 120px;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            @apply p-2 transition duration-150 ease-in-out;
        }
        /* æ¨™ç¤ºã€Œä»Šå¤©ã€çš„å–®å…ƒæ ¼ */
        .is-today {
            @apply ring-2 ring-indigo-500 ring-offset-2 bg-indigo-50/50; 
        }
        .day-cell:hover {
            @apply bg-gray-50;
        }
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-bar-container {
            @apply w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700 mt-1;
        }
        /* è®Šæ›´é€²åº¦æ¢é¡è‰²ç‚ºç¶ è‰²ï¼Œä»£è¡¨ã€Œå®Œæˆã€ */
        .progress-bar {
            @apply h-1.5 rounded-full bg-green-500; 
        }
    </style>
</head>
<body>

<div id="app" class="flex h-screen bg-gray-100">

    <aside class="w-64 bg-white shadow-xl flex-shrink-0 overflow-y-auto">
        <div class="p-6 border-b">
            <h1 class="text-2xl font-bold text-indigo-600">ğŸ§  å­¸ç¿’èª²ç¶±</h1>
            <p class="text-sm text-gray-500 mt-1">Personal Curriculum Planner</p>
        </div>
        
        <div class="p-4">
            <h2 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2 flex justify-between items-center">
                <span>ğŸ“‚ å…­å¤§èª²ç¨‹</span>
                </h2>
            <ul>
                <li v-for="course in courses" :key="course.id" 
                    :class="['p-3 rounded-lg mb-2 flex flex-col transition duration-150', activeCourse === course.id ? 'bg-indigo-50 border-l-4 border-indigo-600 font-medium text-indigo-700' : 'text-gray-600 hover:bg-gray-50']">
                    
                    <div class="flex justify-between items-start w-full">
                        <span @click="activeCourse = course.id" class="cursor-pointer flex-grow">{{ course.icon }} {{ course.name }}</span>
                        
                        <button @click.stop="editCourseName(course)" class="ml-2 text-gray-400 hover:text-indigo-600 transition">
                            âœï¸
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-1 italic" @click="activeCourse = course.id">
                        ç›®æ¨™ï¼š{{ course.goal || 'å°šæœªè¨­å®š' }}
                    </p>

                    <div class="flex justify-between items-center w-full mt-1" @click="activeCourse = course.id">
                        <span :class="['text-xs px-2 py-0.5 rounded-full', courseScheduleCounts[course.id].totalScheduledCount > 0 ? 'bg-indigo-200 text-indigo-800' : 'bg-gray-200 text-gray-700']">
                            {{ courseScheduleCounts[course.id].completedCount }} / {{ courseScheduleCounts[course.id].totalScheduledCount }}
                        </span>
                    </div>

                    <div class="progress-bar-container mt-1">
                        <div class="progress-bar" :style="{ width: courseScheduleCounts[course.id].percentage + '%' }"></div>
                    </div>
                    
                    <p v-if="courseScheduleCounts[course.id].totalScheduledCount > 0" class="text-xs text-gray-500 mt-1 self-end">
                        æœ¬æœˆå·²å®Œæˆ {{ courseScheduleCounts[course.id].completedCount }} / {{ courseScheduleCounts[course.id].totalScheduledCount }} æ¬¡æ’ç¨‹ ({{ courseScheduleCounts[course.id].percentage.toFixed(0) }}%)
                    </p>
                    <p v-else class="text-xs text-gray-500 mt-1 self-end">
                        æœ¬æœˆå°šç„¡æ’ç¨‹
                    </p>

                </li>
            </ul>
        </div>
    </aside>

    <main class="flex-grow overflow-y-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">
                ğŸ“… å­¸ç¿’è¡Œäº‹æ›†è¦åŠƒ
            </h2>
            <div class="flex items-center space-x-3">
                <button @click="changeMonth(-1)" class="p-2 rounded-full bg-white shadow hover:bg-gray-100 transition">â† ä¸Šå€‹æœˆ</button>
                <span class="text-lg font-normal text-indigo-600">{{ currentMonthDisplay }}</span>
                <button @click="changeMonth(1)" class="p-2 rounded-full bg-white shadow hover:bg-gray-100 transition">ä¸‹å€‹æœˆ â†’</button>
                
                <button @click="exportCoursesJson" class="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">
                    ğŸ“¥ åŒ¯å‡ºèª²ç¨‹æ•¸æ“š (JSON)
                </button>
                <button @click="exportToCSV" class="py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition">
                    ğŸ“¥ åŒ¯å‡ºæ’ç¨‹ (CSV)
                </button>
            </div>
        </div>
        
        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <h3 class="text-xl font-semibold mb-3 text-gray-800 flex justify-between items-center">
                <span>ğŸ“‹ {{ currentCourse.name }}ï¼šå­é …ç›®æ¸…å–®</span>
                <button @click="openSubItemModal({ courseId: activeCourse })" class="text-sm py-1 px-3 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition">
                    + æ–°å¢å­é …ç›®
                </button>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <div v-for="item in currentCourse.subItems" :key="item.id" 
                    :class="['p-3 rounded-lg shadow-sm border transition-shadow hover:shadow-md cursor-pointer', statusColor(item.status).bg, statusColor(item.status).border]"
                    @click="openSubItemModal(item)"> 
                    <p class="font-medium">{{ item.title }}</p>
                    <p :class="['text-xs mt-1', statusColor(item.status).text]">{{ item.status }}</p>
                    <button @click.stop="openScheduleModal(item)" class="text-xs mt-2 text-indigo-600 hover:text-indigo-800">
                        é»æ“Šæ’ç¨‹åˆ°è¡Œäº‹æ›† â†’
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg">
            <div class="calendar-grid font-bold text-center text-gray-600 bg-gray-50">
                <div class="p-2">æ—¥</div>
                <div class="p-2">ä¸€</div>
                <div class="p-2">äºŒ</div>
                <div class="p-2">ä¸‰</div>
                <div class="p-2">å››</div>
                <div class="p-2">äº”</div>
                <div class="p-2">å…­</div>
            </div>
            
            <div class="calendar-grid">
                <div v-for="day in daysInMonth" :key="day.date" 
                    :class="['day-cell relative', day.isCurrentMonth ? 'bg-white' : 'bg-gray-50 text-gray-400', {'is-today': day.isToday}]"
                    @drop="handleDrop($event, day.date)"
                    @dragover.prevent>
                    
                    <span class="text-sm font-semibold" :class="{'text-indigo-600': day.isToday}">{{ day.dayNum }}</span>
                    
                    <div v-if="scheduledItems[day.date] && scheduledItems[day.date].length > 0">
                        <div v-for="(schedule, index) in scheduledItems[day.date]" :key="index" 
                            :class="['mt-1 px-1 py-0.5 rounded-md text-xs truncate cursor-pointer', statusColor(schedule.status).bg, statusColor(schedule.status).text]">
                            <span class="font-medium">{{ schedule.eventTitle }}</span>
                            <div class="absolute inset-0" @click="openRecordModal(schedule, day.date)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div v-if="isScheduleModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">æ’ç¨‹è¦åŠƒï¼š{{ schedulingItem.title }}</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-indigo-700">é¸æ“‡ **å…·é«”** è¡Œäº‹æ›†äº‹ä»¶</label>
                <select v-model="scheduleEventTitle" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option v-for="(event, index) in schedulingItem.events" :key="index">{{ event }}</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">é¸æ“‡ **èµ·å§‹** æ—¥æœŸ</label>
                <input type="date" v-model="scheduleDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">é‡è¤‡é »ç‡</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" v-model="scheduleRecurrence" value="once" class="form-radio text-indigo-600">
                        <span class="ml-2 text-gray-700">å–®æ¬¡</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" v-model="scheduleRecurrence" value="weekly" class="form-radio text-indigo-600">
                        <span class="ml-2 text-gray-700">æ¯é€± (æŒçºŒ 4 é€±)</span>
                    </label>
                </div>
                <p v-if="scheduleRecurrence === 'weekly'" class="text-xs text-red-500 mt-1">æ’ç¨‹å°‡è‡ªå‹•å»ºç«‹ 4 å€‹æœ¬é€±æœŸçš„é‡è¤‡äº‹ä»¶ï¼Œç›´åˆ° 2026/3 æœˆåº•ã€‚</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button @click="isScheduleModalOpen = false" class="py-2 px-4 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button @click="scheduleActivity" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">ç¢ºèªæ’ç¨‹</button>
            </div>
        </div>
    </div>
    
    <div v-if="isRecordModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4">æ’ç¨‹ç´€éŒ„ã€çµæœèˆ‡ç·¨è¼¯ï¼š({{ recordingDate }})</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">æ‰€å±¬å­é …ç›®</label>
                <p class="mt-1 text-base font-semibold">{{ recordingItem.title }}</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">å…·é«”äº‹ä»¶ (å¯ç·¨è¼¯)</label>
                <input type="text" v-model="recordingItem.eventTitle" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="è«‹è¼¸å…¥å…·é«”äº‹ä»¶æ¨™é¡Œ">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">åŸ·è¡Œç‹€æ³ (ç‹€æ…‹æ›´æ–°)</label>
                <select v-model="recordingItem.status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option>æœªé–‹å§‹</option>
                    <option>é€²è¡Œä¸­</option>
                    <option>å·²å®Œæˆ</option>
                    <option>å»¶æœŸ/ä¸­æ–·</option>
                </select>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700">éç¨‹èˆ‡åæ€ç´€éŒ„</label>
                <textarea v-model="recordingItem.notes" rows="4" placeholder="è¨˜éŒ„ä»Šæ—¥å­¸ç¿’äº†ä»€éº¼ã€é‡åˆ°çš„å›°é›£ã€æˆ–å–å¾—çš„æˆæœã€‚" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-between items-center pt-3 border-t">
                <button @click="deleteSchedule" class="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                    ğŸ—‘ï¸ åˆªé™¤è¡Œç¨‹
                </button>
                <div class="flex space-x-3">
                    <button @click="isRecordModalOpen = false" class="py-2 px-4 text-gray-600 hover:text-gray-800">é—œé–‰</button>
                    <button @click="saveRecord" class="py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700">å„²å­˜ç´€éŒ„</button>
                </div>
            </div>
        </div>
    </div>
    
    <div v-if="isSubItemModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4">{{ editingSubItem.id ? 'ç·¨è¼¯å­é …ç›®' : 'æ–°å¢å­é …ç›®' }}</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">å­é …ç›®æ¨™é¡Œ (ä¾‹å¦‚ï¼šå†’ç‰Œè€…ç„¦æ…®èª¿ç¯€)</label>
                <input type="text" v-model="editingSubItem.title" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">ç›®å‰ç‹€æ…‹</label>
                <select v-model="editingSubItem.status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option>æœªé–‹å§‹</option>
                    <option>é€²è¡Œä¸­</option>
                    <option>å·²å®Œæˆ</option>
                    <option>å»¶æœŸ/ä¸­æ–·</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700">å…·é«”äº‹ä»¶æ¸…å–® (æ¯è¡Œä¸€å€‹ï¼Œä½œç‚ºæ’ç¨‹é¸é …)</label>
                <textarea v-model="editingSubItemEventsText" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="ä¾‹å¦‚ï¼š\nCalm Appï¼Headspace å†¥æƒ³ 5 åˆ†é˜\næ™šé–“ RESET åæ€ï¼ˆå¯«ä¸€å¥è©±ï¼‰"></textarea>
                <p class="text-xs text-gray-500 mt-1">è«‹æ³¨æ„ï¼šé€™äº›é¸é …å°‡æœƒæˆç‚ºæ’ç¨‹æ™‚çš„å…·é«”äº‹ä»¶æ¨™é¡Œã€‚</p>
            </div>
            
            <div class="flex justify-between items-center pt-3 border-t">
                <button v-if="editingSubItem.id" @click="deleteSubItem" class="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                    ğŸ—‘ï¸ åˆªé™¤å­é …ç›®
                </button>
                <div class="flex space-x-3 ml-auto">
                    <button @click="isSubItemModalOpen = false" class="py-2 px-4 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                    <button @click="saveSubItem" :disabled="!editingSubItem.title" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50">
                        å„²å­˜å­é …ç›®
                    </button>
                </div>
            </div>
        </div>
    </div>


</div>

<script>
    const { createApp, ref, reactive, computed, watch } = Vue

    // --- æ—¥æœŸæ ¼å¼åŒ–å·¥å…· ---
    const formatDate = (date) => {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        let year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    }

    // --- æ ¸å¿ƒéœæ…‹æ•¸æ“š (ä½œç‚ºé¦–æ¬¡è¼‰å…¥çš„é è¨­å€¼) ---
    // é è¨­è³‡æ–™ä¸­æ–°å¢äº† goal æ¬„ä½
    const DEFAULT_COURSES = [
        { id: 1, name: 'å¿ƒç†æˆé•· Ã— è‡ªä¿¡é›éŠ', icon: 'ğŸ§ ', goal: 'æ¯é€±è‡³å°‘ 2 æ¬¡å¿ƒç†ç·´ç¿’ï¼Œæå‡å·¥ä½œç©©å®šæ€§ã€‚', subItems: [
            { id: 101, title: 'å†’ç‰Œè€…ç„¦æ…®èª¿ç¯€', status: 'æœªé–‹å§‹', notes: '', events: ['é–±è®€ Crucial Conversations ç¬¬ 1 ç« ï¼ˆ10 åˆ†é˜ï¼‰', 'åšä¸€æ¬¡ã€Œä»Šæ—¥ç„¦æ…®ä¾†æº 3 å•ã€åæ€ï¼ˆ3 åˆ†é˜ï¼‰', 'è½ The Mindset Mentor podcastï¼ˆä»»ä¸€é›†ï¼Œ10 åˆ†é˜ï¼‰']},
            { id: 102, title: 'è‡ªä¿¡è‚Œè‚‰ç·´ç¿’', status: 'æœªé–‹å§‹', notes: '', events: ['å¯«ä¸‹ 2 ä»¶ä»Šå¤©åšå¾—å¥½çš„äº‹ï¼ˆ2 åˆ†é˜ï¼‰', 'éŒ„ 30 ç§’æ­£å‘è‡ªæˆ‘è‚¯å®šèªéŸ³ï¼ˆä¸å…¬é–‹ï¼‰'] },
            { id: 103, title: 'å¿ƒç†å®‰å®šç·´ç¿’', status: 'æœªé–‹å§‹', notes: '', events: ['Calm Appï¼Headspace å†¥æƒ³ 5 åˆ†é˜', 'æ™šé–“ RESET åæ€ï¼ˆå¯«ä¸€å¥è©±ï¼‰'] },
        ]},
        { id: 2, name: 'Finance Ã— AI Ã— Insight é›™è»Œå°ˆæ¥­åŠ›', icon: 'ğŸ“Š', goal: 'å®Œæˆè²¡å ±åŸºç¤é–±è®€ï¼Œä¸¦åœ¨ Power BI å ±è¡¨ä¸Šæ‡‰ç”¨ 3 å€‹æ–° DAX å…¬å¼ã€‚', subItems: [
            { id: 201, title: 'è²¡å ± Ã— è²¡ç¨…è£œå¼·', status: 'æœªé–‹å§‹', notes: '', events: ['é–±è®€è²¡å ±åˆ†ææ›¸ç±ã€Šè²¡å ±å°±åƒä¸€æœ¬æ•…äº‹æ›¸ã€‹ç¬¬ 1 ç« ï¼ˆ15 åˆ†é˜ï¼‰', 'çœ‹ä¸€æ¬¡ã€Œæ”¿åºœè²¡æ”¿éƒ¨åŸºç¤ç¨…å‹™å½±ç‰‡ã€ï¼ˆYouTube 10 åˆ†é˜ï¼‰', 'æ•´ç† 1 å€‹ç¨…å‹™åè©ï¼ˆä¾‹å¦‚éå»¶æ‰€å¾—ç¨…ï¼‰'] },
            { id: 202, title: 'ä¸»å‹•å¼è²¡å‹™åˆ†æ', status: 'æœªé–‹å§‹', notes: '', events: ['å°æœ¬é€±è³‡æ–™åš 3 Why åˆ†æï¼ˆ10 åˆ†é˜ï¼‰', 'å¯«ä¸€æ®µã€Œå¦‚æœä¸»ç®¡å•æˆ‘é€™å€‹æ•¸å­—ï¼Œæˆ‘æœƒæ€éº¼è§£é‡‹ï¼Ÿã€ï¼ˆ5 åˆ†é˜ï¼‰'] },
            { id: 203, title: 'Power BI Ã— AI å¯¦ä½œ', status: 'æœªé–‹å§‹', notes: '', events: ['Power BI è‡ªå‹•åŒ–ç·´ç¿’ï¼šæ–°å¢ 1 å€‹è¨ˆç®—æ¬„ä½ï¼ˆ15 åˆ†é˜ï¼‰', 'ç”¨ ChatGPT ç”Ÿæˆ Power BI DAX è§£é‡‹ï¼ˆ10 åˆ†é˜ï¼‰', 'æ•´ç† Power BI å ±è¡¨æµç¨‹ï¼ˆ10 åˆ†é˜ï¼‰'] },
        ]},
        { id: 3, name: 'å€‹äººè²¡å‹™ Ã— é–‹æº Ã— è²·æˆ¿è¨ˆç•«', icon: 'ğŸ’°', goal: 'å„²è“„ç‡é” 60%ï¼Œä¸¦èƒ½è§£é‡‹ 3 å€‹æˆ¿è²¸åè©ã€‚', subItems: [
            { id: 301, title: 'æŠ•è³‡ç¿’æ…£', status: 'æœªé–‹å§‹', notes: '', events: ['æª¢æŸ¥å°è‚¡ï¼ç¾è‚¡éƒ¨ä½ï¼ˆ5 åˆ†é˜ï¼‰', 'é–±è®€æŠ•è³‡æ–‡ç«  1 ç¯‡ï¼ˆ5 åˆ†é˜ï¼‰', 'ç´€éŒ„æœ¬é€±æŠ•è³‡å¿ƒå¾—ï¼ˆ3 åˆ†é˜ï¼‰'] },
            { id: 302, title: 'é–‹æºæ–¹å‘æ¢ç´¢', status: 'æœªé–‹å§‹', notes: '', events: ['æ•´ç† 1 å€‹å¯è®Šç¾èƒ½åŠ›ï¼ˆ5 åˆ†é˜ï¼‰', 'å¯« 1 ç¯‡çŸ¥è­˜å‹å…§å®¹è‰ç¨¿ï¼ˆ10â€“15 åˆ†é˜ï¼‰'] },
            { id: 303, title: 'è²·æˆ¿è¨ˆç•«', status: 'æœªé–‹å§‹', notes: '', events: ['è¨ˆç®—æœ¬æœˆå„²è“„ç‡ï¼ˆ5 åˆ†é˜ï¼‰', 'è©¦ç®—é ­æœŸé‡‘éœ€è¦çš„æ™‚é–“ï¼ˆ10 åˆ†é˜ï¼‰', 'ç ”ç©¶ 1 å€‹æˆ¿è²¸åè©ï¼ˆ5 åˆ†é˜ï¼‰'] },
        ]},
        { id: 4, name: 'è‹±èªè¡¨é” Ã— åœ‹éš›æºé€š', icon: 'ğŸ—£ï¸', goal: 'æ¯é€±èƒ½æµåˆ©ä½¿ç”¨ 5 å€‹å¤–å•†æœƒè­°ç”¨å¥ã€‚', subItems: [
            { id: 401, title: 'å¤–å•†è‹±æ–‡å¿…å‚™', status: 'æœªé–‹å§‹', notes: '', events: ['å­¸ 5 å€‹å¤–å•†æœƒè­°ç”¨å¥ï¼ˆ10 åˆ†é˜ï¼‰', 'é–±è®€ 1 é è‹±æ–‡å°èªªï¼ˆ5 åˆ†é˜ï¼‰'] },
            { id: 402, title: 'è¡¨é”å¯¦æˆ°', status: 'æœªé–‹å§‹', notes: '', events: ['éŒ„ 30 ç§’è‹±æ–‡å³å¸­å›ç­”ï¼ˆä¸å…¬é–‹ï¼‰', 'åš 3 å€‹æœƒè­°æ•¸æ“šè‹±æ–‡å¥å‹ï¼ˆ10 åˆ†é˜ï¼‰'] },
            { id: 403, title: 'æ²‰æµ¸å¼ç·´ç¿’', status: 'æœªé–‹å§‹', notes: '', events: ['çœ‹å¤–åœ‹ vlog 10 åˆ†é˜', 'AmazingTalker èª²å¾Œå¯« recapï¼ˆ5 åˆ†é˜ï¼‰'] },
        ]},
        { id: 5, name: 'å€‹äººå“ç‰Œ Ã— å‰¯æ¥­ Hard Data å…§å®¹', icon: 'ğŸ’¡', goal: 'è¼¸å‡º 2 ç¯‡ Hard Data çŸ¥è­˜å…§å®¹è‰ç¨¿ï¼Œé–å®šç›®æ¨™å—çœ¾ã€‚', subItems: [
            { id: 501, title: 'å®šä½è·‘ç‰ˆ', status: 'æœªé–‹å§‹', notes: '', events: ['å¯«å‡º 5 å€‹ä½ èƒ½åˆ†äº«çš„ Hard Data ä¸»é¡Œï¼ˆ10 åˆ†é˜ï¼‰', 'æ•´ç†å¤–å•†æ—¥å¸¸å¿ƒå¾— 1 å‰‡'] },
            { id: 502, title: 'çŸ¥è­˜å‹å…§å®¹å‰µä½œ', status: 'æœªé–‹å§‹', notes: '', events: ['æ’°å¯« 1 ç¯‡ä¸å…¬é–‹å…§å®¹ï¼ˆ15â€“20 åˆ†é˜ï¼‰'] },
            { id: 503, title: 'è³‡è¨Šå·®è®Šç¾æ¢ç´¢', status: 'æœªé–‹å§‹', notes: '', events: ['è§€å¯Ÿ 1 å€‹å¯ä»¥åšæˆè³‡è¨Šç”¢å“çš„ä¸»é¡Œï¼ˆ10 åˆ†é˜ï¼‰', 'æ•´ç† 1 å€‹ä½ èƒ½æ•™åˆ¥äººçš„æµç¨‹ï¼ˆ10 åˆ†é˜ï¼‰'] },
        ]},
        { id: 6, name: 'ç”Ÿæ´»é«”é©— Ã— éˆæ„Ÿ Ã— ç¾æ„Ÿæ¢ç´¢', icon: 'ğŸ§˜', goal: 'æ¯æœˆå®Œæˆ 1 é …æ–°é«”é©—ï¼Œä¸¦ç´€éŒ„ 3 å‰‡ç”Ÿæ´»éˆæ„Ÿã€‚', subItems: [
            { id: 601, title: 'æ¯æœˆæ–°é«”é©—', status: 'æœªé–‹å§‹', notes: '', events: ['å®‰æ’é€™å€‹æœˆçš„é«”é©—æ´»å‹•ï¼ˆ10 åˆ†é˜ï¼‰'] },
            { id: 602, title: 'éˆæ„Ÿç´€éŒ„', status: 'æœªé–‹å§‹', notes: '', events: ['å¯« 3 å¥ã€Œä»Šæ—¥éˆæ„Ÿã€', 'æ•´ç†æœ¬é€±éˆæ„Ÿï¼ˆ5 åˆ†é˜ï¼‰'] },
            { id: 603, title: 'æ—…éŠ Ã— ç¾æ„Ÿç´¯ç©', status: 'æœªé–‹å§‹', notes: '', events: ['Pinterest æœé›†éˆæ„Ÿï¼ˆ10 åˆ†é˜ï¼‰', 'å¯« 1 å‰‡ç”Ÿæ´»é«”é©—å¿ƒå¾—ï¼ˆ5 åˆ†é˜ï¼‰'] },
        ]},
    ];
    
    // é è¨­æ’ç¨‹æ•¸æ“š
    const DEFAULT_SCHEDULED_ITEMS = {
        '2025-12-05': [
            { id: 101, title: 'å†’ç‰Œè€…ç„¦æ…®èª¿ç¯€', status: 'å·²å®Œæˆ', notes: 'ä»Šæ—¥ç·´ç¿’ Crucial Conversations ç¬¬ä¸€ç« å°è®€ã€‚', eventTitle: 'é–±è®€ Crucial Conversations ç¬¬ 1 ç« ï¼ˆ10 åˆ†é˜ï¼‰', courseId: 1 },
            { id: 301, title: 'æŠ•è³‡ç¿’æ…£', status: 'é€²è¡Œä¸­', notes: '', eventTitle: 'æª¢æŸ¥å°è‚¡ï¼ç¾è‚¡éƒ¨ä½ï¼ˆ5 åˆ†é˜ï¼‰', courseId: 3 }
        ],
        '2025-12-12': [
            { id: 101, title: 'å†’ç‰Œè€…ç„¦æ…®èª¿ç¯€', status: 'æœªé–‹å§‹', notes: '', eventTitle: 'é–±è®€ Crucial Conversations ç¬¬ 1 ç« ï¼ˆ10 åˆ†é˜ï¼‰', courseId: 1 },
        ],
        '2026-01-15': [
            { id: 203, title: 'Power BI Ã— AI å¯¦ä½œ', status: 'æœªé–‹å§‹', notes: '', eventTitle: 'Power BI è‡ªå‹•åŒ–ç·´ç¿’ï¼šæ–°å¢ 1 å€‹è¨ˆç®—æ¬„ä½ï¼ˆ15 åˆ†é˜ï¼‰', courseId: 2 }
        ],
    };

    // --- LocalStorage å‡½æ•¸ ---
    const LS_KEY_COURSES = 'planner_courses';
    const LS_KEY_SCHEDULES = 'planner_schedules';

    const saveToLocalStorage = (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
            console.error('Error saving to LocalStorage', e);
        }
    };

    const loadFromLocalStorage = (key, defaultValue) => {
        try {
            const stored = localStorage.getItem(key);
            if (stored) {
                return JSON.parse(stored);
            }
        } catch (e) {
            console.error('Error loading from LocalStorage', e);
            // è¼‰å…¥å¤±æ•—æ™‚ï¼Œæ¸…é™¤èˆŠè³‡æ–™ä¸¦è¿”å›é è¨­å€¼
            localStorage.removeItem(key);
        }
        return defaultValue;
    };
    
    
    createApp({
        setup() {
            
            // è¼‰å…¥æˆ–ä½¿ç”¨é è¨­å€¼
            const courses = reactive(loadFromLocalStorage(LS_KEY_COURSES, DEFAULT_COURSES));
            const scheduledItems = reactive(loadFromLocalStorage(LS_KEY_SCHEDULES, DEFAULT_SCHEDULED_ITEMS));
            
            // --- ç›£è½æ•¸æ“šè®ŠåŒ–ä¸¦è‡ªå‹•å„²å­˜ ---
            watch(courses, (newCourses) => {
                saveToLocalStorage(LS_KEY_COURSES, newCourses);
            }, { deep: true }); // æ·±åº¦ç›£è½
            
            watch(scheduledItems, (newScheduledItems) => {
                saveToLocalStorage(LS_KEY_SCHEDULES, newScheduledItems);
            }, { deep: true }); // æ·±åº¦ç›£è½
            
            // ***************************************************************

            const activeCourse = ref(1);
            
            // è¡Œäº‹æ›†æœˆä»½é‚è¼¯ (å¾ 2025/12 é–‹å§‹)
            const currentYear = ref(2025); 
            const currentMonth = ref(11); // 11 = 12æœˆ (JavaScript Month Index 0-11)
            
            // --- SubItem Modal ç‹€æ…‹ (æ–°å¢) ---
            const isSubItemModalOpen = ref(false);
            const editingSubItem = ref({});
            const editingSubItemEventsText = ref('');
            
            // --- Computed & Helper Functions ---
            const currentCourse = computed(() => {
                return courses.find(c => c.id === activeCourse.value) || { name: 'ç„¡é¸å–èª²ç¨‹', subItems: [] };
            });

            const statusColor = (status) => {
                const map = {
                    'æœªé–‹å§‹': { bg: 'bg-gray-100', text: 'text-gray-600', border: 'border-gray-400' },
                    'é€²è¡Œä¸­': { bg: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-500' },
                    'å·²å®Œæˆ': { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-500' },
                    'å»¶æœŸ/ä¸­æ–·': { bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-500' },
                };
                return map[status] || map['æœªé–‹å§‹'];
            };
            
            const currentMonthDisplay = computed(() => {
                return `${currentYear.value} å¹´ ${currentMonth.value + 1} æœˆ`;
            });
            
            // æœˆä»½åˆ‡æ›å‡½æ•¸
            const changeMonth = (delta) => {
                let newDate = new Date(currentYear.value, currentMonth.value + delta, 1);
                
                // é™åˆ¶æœˆä»½ç¯„åœåœ¨ 2025/12 - 2026/03
                const minDate = new Date(2025, 11, 1); 
                const maxDate = new Date(2026, 3, 1); 
                
                if (newDate.getTime() >= minDate.getTime() && newDate.getTime() < maxDate.getTime()) {
                    currentYear.value = newDate.getFullYear();
                    currentMonth.value = newDate.getMonth();
                } else {
                    alert('ç›®å‰åªæä¾› 2025 å¹´ 12 æœˆåˆ° 2026 å¹´ 3 æœˆçš„è¦åŠƒç¯„åœã€‚');
                }
            };


            const daysInMonth = computed(() => {
                const year = currentYear.value; 
                const month = currentMonth.value; 
                const days = [];
                const today = formatDate(new Date());

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDayOfWeek = firstDay.getDay(); 
                
                // æ¸²æŸ“ä¸Šå€‹æœˆçš„æ—¥æœŸ
                for (let i = 0; i < startDayOfWeek; i++) {
                    const prevMonthDate = new Date(year, month, i - startDayOfWeek + 1);
                    days.push({ dayNum: prevMonthDate.getDate(), isCurrentMonth: false, date: '' }); 
                }

                // æ¸²æŸ“ç•¶å‰æœˆä»½çš„æ—¥æœŸ
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    days.push({ 
                        dayNum: i, 
                        isCurrentMonth: true, 
                        date: dateStr, 
                        isToday: (dateStr === today) // æ¨™è¨˜ä»Šå¤©
                    });
                }
                
                // æ¸²æŸ“ä¸‹å€‹æœˆçš„æ—¥æœŸ (è£œæ»¿æ ¼å­)
                const totalCells = days.length;
                const remainingCells = 42 - totalCells; 
                for (let i = 1; i <= remainingCells; i++) {
                    const nextMonthDate = new Date(year, month + 1, i);
                    days.push({ dayNum: nextMonthDate.getDate(), isCurrentMonth: false, date: '' });
                }
                
                return days;
            });

            // é€²åº¦è¨ˆç®—é‚è¼¯ (æ–¹æ¡ˆäºŒï¼šå·²å®Œæˆæ¬¡æ•¸ / ç¸½æ’ç¨‹æ¬¡æ•¸)
            const courseScheduleCounts = computed(() => {
                const counts = {};
                const currentMonthKey = `${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}`;
                
                // åˆå§‹åŒ–è¨ˆæ•¸å™¨
                for (const course of courses) {
                    counts[course.id] = { 
                        completedCount: 0, // å·²å®Œæˆæ¬¡æ•¸
                        totalScheduledCount: 0, // ç¸½æ’ç¨‹æ¬¡æ•¸
                        percentage: 0 
                    };
                }

                // è¨ˆç®—ç•¶æœˆæ’ç¨‹ç¸½æ¬¡æ•¸å’Œå®Œæˆæ¬¡æ•¸
                for (const date in scheduledItems) {
                    if (date.startsWith(currentMonthKey)) {
                        for (const item of scheduledItems[date]) {
                            if (item.courseId) {
                                const courseId = item.courseId;
                                counts[courseId].totalScheduledCount += 1; // ç¸½æ’ç¨‹ +1
                                if (item.status === 'å·²å®Œæˆ') {
                                    counts[courseId].completedCount += 1; // å®Œæˆ +1
                                }
                            }
                        }
                    }
                }
                
                // è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”: (å®Œæˆæ¬¡æ•¸ / ç¸½æ’ç¨‹æ¬¡æ•¸) * 100
                for (const id in counts) {
                    const total = counts[id].totalScheduledCount;
                    const completed = counts[id].completedCount;

                    if (total > 0) {
                        counts[id].percentage = (completed / total) * 100;
                    } else {
                        counts[id].percentage = 0;
                    }
                }
                return counts;
            });

            // --- Modal & Scheduling Logic ---
            const isScheduleModalOpen = ref(false);
            const isRecordModalOpen = ref(false);
            const schedulingItem = ref({});
            const recordingItem = ref({});
            const recordingDate = ref('');
            const scheduleDate = ref(formatDate(new Date()));
            const scheduleEventTitle = ref(''); 
            const scheduleRecurrence = ref('once'); 

            const openScheduleModal = (item) => {
                schedulingItem.value = { ...item }; 
                scheduleDate.value = formatDate(new Date()); 
                scheduleEventTitle.value = item.events[0]; 
                scheduleRecurrence.value = 'once'; 
                isScheduleModalOpen.value = true;
            };

            // è¼”åŠ©å‡½æ•¸ï¼šå°‡äº‹ä»¶æ’å…¥ scheduledItems
            const addItemToSchedule = (dateKey, item) => {
                if (!scheduledItems[dateKey]) {
                    scheduledItems[dateKey] = []; // ç¢ºä¿ç‚ºé™£åˆ—
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ subItem.id å’Œ eventTitleï¼Œé˜²æ­¢é‡è¤‡æ’ç¨‹
                const existingIndex = scheduledItems[dateKey].findIndex(
                    i => i.id === item.id && i.eventTitle === item.eventTitle
                );

                if (existingIndex === -1) {
                    // ä½¿ç”¨ push ç¢ºä¿ scheduledItems[dateKey] æ˜¯é™£åˆ—
                    if (Array.isArray(scheduledItems[dateKey])) {
                        scheduledItems[dateKey].push(item);
                    } else {
                        // è™•ç†èˆŠè³‡æ–™çµæ§‹æˆ– LocalStorage è¼‰å…¥éŒ¯èª¤
                         scheduledItems[dateKey] = [item];
                    }
                    return true;
                }
                return false;
            };

            // æ’ç¨‹æ´»å‹•
            const scheduleActivity = () => {
                if (!scheduleDate.value || !scheduleEventTitle.value) {
                    alert('æ’ç¨‹å¤±æ•—ï¼šè«‹å‹™å¿…è¼¸å…¥æ—¥æœŸä¸¦é¸æ“‡ä¸€å€‹äº‹ä»¶ï¼');
                    return; 
                }
                
                let count = 0;
                let currentDate = new Date(scheduleDate.value.replace(/-/g, '/')); 
                currentDate.setHours(8); // è¨­å®šæ™‚é–“é¿å…æ™‚å€å•é¡Œ
                
                const maxDate = new Date(2026, 3, 31); // é™åˆ¶åˆ° 2026/03/31
                maxDate.setHours(8); // è¨­å®šæ™‚é–“é¿å…æ™‚å€å•é¡Œ

                const baseItem = {
                    id: schedulingItem.value.id,
                    title: schedulingItem.value.title,
                    status: 'æœªé–‹å§‹', 
                    notes: schedulingItem.value.notes || '',
                    eventTitle: scheduleEventTitle.value,
                    courseId: currentCourse.value.id 
                };

                // è™•ç†å–®æ¬¡æ’ç¨‹
                if (scheduleRecurrence.value === 'once') {
                    if (addItemToSchedule(formatDate(currentDate), baseItem)) {
                        count = 1;
                    }
                } 
                // è™•ç†æ¯é€±æ’ç¨‹ (æŒçºŒ 4 é€±)
                else if (scheduleRecurrence.value === 'weekly') {
                    const limit = 4; // æ’ç¨‹ 4 é€±
                    let scheduledWeeks = 0;
                    
                    while (scheduledWeeks < limit && currentDate <= maxDate) {
                        const dateKey = formatDate(currentDate);
                        
                        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ‰æ•ˆæœˆä»½ç¯„åœå…§
                        const currentMonthLimit = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                        const minDate = new Date(2025, 11, 1);
                        
                        if (currentMonthLimit.getTime() >= minDate.getTime() && currentMonthLimit.getTime() < new Date(2026, 4, 1).getTime()) {
                            if (addItemToSchedule(dateKey, baseItem)) {
                                count++;
                                scheduledWeeks++;
                            }
                        }

                        // ç§»å‹•åˆ°ä¸‹ä¸€é€±çš„åŒä¸€å¤©
                        currentDate.setDate(currentDate.getDate() + 7);
                    }
                }
                
                if (count > 0) {
                    alert(`æˆåŠŸæ’ç¨‹ ${count} å€‹ [${scheduleEventTitle.value}] äº‹ä»¶ï¼`);
                } else {
                    alert('æ’ç¨‹å¤±æ•—æˆ–äº‹ä»¶å·²å­˜åœ¨ã€‚');
                }
                
                isScheduleModalOpen.value = false;
                scheduleDate.value = formatDate(new Date()); 
                scheduleEventTitle.value = '';
                scheduleRecurrence.value = 'once';
            };


            const openRecordModal = (schedule, date) => {
                // è¤‡è£½ç‰©ä»¶ä»¥ç¢ºä¿ v-model ä¸ç›´æ¥ä¿®æ”¹åŸå§‹ reactive è³‡æ–™ï¼Œç›´åˆ°æŒ‰ä¸‹å„²å­˜
                recordingItem.value = { ...schedule }; 
                recordingDate.value = date;
                isRecordModalOpen.value = true;
            }

            const saveRecord = () => {
                const { id, status, notes, eventTitle } = recordingItem.value; 

                // 1. æ›´æ–°ä¸»æ¸…å–®ç‹€æ…‹
                for (let c of courses) {
                    const subItem = c.subItems.find(item => item.id === id);
                    if (subItem) {
                        subItem.status = status;
                        subItem.notes = notes;
                        break;
                    }
                }

                // 2. æ›´æ–°è¡Œäº‹æ›†ä¸­è©²å–®ä¸€æ’ç¨‹çš„ç‹€æ…‹ã€ç­†è¨˜å’Œ eventTitle
                if (scheduledItems[recordingDate.value] && Array.isArray(scheduledItems[recordingDate.value])) {
                    scheduledItems[recordingDate.value] = scheduledItems[recordingDate.value].map(schedule => {
                        // å¿…é ˆç¢ºä¿æ˜¯åŒä¸€å€‹ subItem id å’ŒåŸæœ¬çš„ eventTitle æ‰èƒ½æ›´æ–°
                        if (schedule.id === id && schedule.courseId === recordingItem.value.courseId) {
                            schedule.status = status;
                            schedule.notes = notes;
                            schedule.eventTitle = eventTitle; // æ›´æ–° eventTitle
                        }
                        return schedule;
                    });
                }


                alert(`[${eventTitle}] çš„ç´€éŒ„å·²å„²å­˜ï¼`);
                isRecordModalOpen.value = false;
            }

            // åˆªé™¤è¡Œç¨‹
            const deleteSchedule = () => {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ [${recordingItem.value.eventTitle}] åœ¨ ${recordingDate.value} çš„è¡Œç¨‹å—ï¼Ÿ`)) {
                    return;
                }
                
                const dateKey = recordingDate.value;
                const itemToDelete = recordingItem.value;

                if (scheduledItems[dateKey] && Array.isArray(scheduledItems[dateKey])) {
                    scheduledItems[dateKey] = scheduledItems[dateKey].filter(item => 
                        // å¿…é ˆåŒæ™‚åŒ¹é… id å’Œ eventTitle æ‰èƒ½ç¢ºä¿åˆªé™¤å–®ä¸€æ’ç¨‹
                        !(item.id === itemToDelete.id && item.eventTitle === itemToDelete.eventTitle)
                    );

                    if (scheduledItems[dateKey].length === 0) {
                        delete scheduledItems[dateKey];
                    }

                    alert(`æˆåŠŸåˆªé™¤ [${itemToDelete.eventTitle}] åœ¨ ${dateKey} çš„è¡Œç¨‹ï¼`);
                    isRecordModalOpen.value = false;
                    recordingItem.value = {};
                    recordingDate.value = '';
                } else {
                    alert('åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°è©²è¡Œç¨‹ã€‚');
                }
            };

            
            const handleDrop = (event, date) => {
                if(date) { 
                    alert(`è«‹ä½¿ç”¨ã€Œé»æ“Šæ’ç¨‹ã€åŠŸèƒ½ä¾†è¨­å®šå…·é«”äº‹ä»¶å’Œé‡è¤‡é »ç‡ï¼`);
                }
            };
            
            // åŒ¯å‡ºè‡³ CSV æª”æ¡ˆ
            const exportToCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
                
                let headers = ["æ—¥æœŸ", "èª²ç¨‹ID", "å­é …ç›®ID", "èª²ç¨‹åç¨±", "å­é …ç›®åç¨±", "å…·é«”äº‹ä»¶", "ç‹€æ…‹", "ç­†è¨˜/åæ€"];
                csvContent += headers.join(",") + "\n";
                
                const allScheduledItems = [];
                // å¿…é ˆä½¿ç”¨ Array.isArray ç¢ºä¿ scheduledItems[date] æ˜¯é™£åˆ—
                for (const date in scheduledItems) {
                    if (Array.isArray(scheduledItems[date]) && scheduledItems[date].length > 0) {
                        for (const item of scheduledItems[date]) {
                            allScheduledItems.push({ ...item, date: date });
                        }
                    }
                }
                
                allScheduledItems.sort((a, b) => (a.date > b.date) ? 1 : -1);

                allScheduledItems.forEach(item => {
                    const course = courses.find(c => c.id === item.courseId);
                    const courseName = course?.name || 'æœªçŸ¥èª²ç¨‹';
                    
                    // ç¢ºä¿ CSV å…§å®¹æ­£ç¢ºé€ƒé€¸ (escape quotes)
                    const escape = (text) => `"${String(text).replace(/"/g, '""')}"`;

                    const row = [
                        item.date,
                        item.courseId,
                        item.id, // å­é …ç›® ID
                        escape(courseName),
                        escape(item.title), // å­é …ç›®åç¨±
                        escape(item.eventTitle),
                        escape(item.status),
                        escape(item.notes)
                    ];
                    csvContent += row.join(",") + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `å€‹äººå­¸ç¿’èª²ç¶±æ’ç¨‹_${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // ç·¨è¼¯èª²ç¨‹åç¨± (å·²ä¿®æ”¹ï¼Œå¢åŠ äº†ç·¨è¼¯ç›®æ¨™)
            const editCourseName = (course) => {
                const newName = prompt(`ç·¨è¼¯èª²ç¨‹åç¨± (${course.icon})ï¼š`, course.name);
                if (newName !== null && newName.trim() !== '') {
                    const index = courses.findIndex(c => c.id === course.id);
                    if (index !== -1) {
                        courses[index].name = newName.trim();
                        // è®Šå‹•æœƒè¢« watch ç›£è½åˆ°ä¸¦è‡ªå‹•å„²å­˜
                    }
                }
                const newGoal = prompt(`ç·¨è¼¯èª²ç¨‹ç›®æ¨™ (${course.name})ï¼š`, course.goal || '');
                if (newGoal !== null) { // å…è¨±ç›®æ¨™ç‚ºç©ºå­—ä¸²
                    const index = courses.findIndex(c => c.id === course.id);
                    if (index !== -1) {
                        courses[index].goal = newGoal.trim();
                        alert(`èª²ç¨‹ [${course.icon} ${courses[index].name}] åç¨±èˆ‡ç›®æ¨™å·²æ›´æ–°ï¼`);
                    }
                }
            };
            
            // å­é …ç›® æ–°å¢/ç·¨è¼¯ é‚è¼¯ (æ–°å¢)
            const openSubItemModal = (item) => {
                // å¦‚æœå‚³å…¥çš„ item åªæœ‰ courseIdï¼Œå‰‡ç‚ºæ–°å¢æ¨¡å¼
                if (item.courseId) {
                    editingSubItem.value = { 
                        id: null, 
                        courseId: item.courseId, // ç”¨æ–¼å®šä½å„²å­˜ä½ç½®
                        title: '', 
                        status: 'æœªé–‹å§‹', 
                        notes: '', 
                        events: [] 
                    };
                    editingSubItemEventsText.value = '';
                } else {
                    // ç·¨è¼¯æ¨¡å¼
                    editingSubItem.value = { ...item, courseId: activeCourse.value }; // æ·»åŠ  courseId ä»¥ä¾¿å®šä½
                    editingSubItemEventsText.value = item.events.join('\n');
                }
                isSubItemModalOpen.value = true;
            };

            const saveSubItem = () => {
                const currentCourseIndex = courses.findIndex(c => c.id === activeCourse.value);
                if (currentCourseIndex === -1) {
                    alert('å„²å­˜å¤±æ•—ï¼šæ‰¾ä¸åˆ°ç›®å‰é¸ä¸­çš„èª²ç¨‹ã€‚');
                    return;
                }
                
                // è™•ç† events æ¬„ä½ï¼šå°‡æ›è¡Œåˆ†éš”çš„æ–‡å­—è½‰ç‚ºé™£åˆ—
                const eventsArray = editingSubItemEventsText.value
                                        .split('\n')
                                        .map(line => line.trim())
                                        .filter(line => line.length > 0);

                // æº–å‚™å„²å­˜çš„ç‰©ä»¶
                const itemToSave = {
                    id: editingSubItem.value.id || Date.now(), // æ–°å¢æ™‚è³¦äºˆå”¯ä¸€çš„ ID
                    title: editingSubItem.value.title.trim(),
                    status: editingSubItem.value.status,
                    notes: editingSubItem.value.notes,
                    events: eventsArray 
                };
                
                const subItems = courses[currentCourseIndex].subItems;

                if (editingSubItem.value.id) {
                    // ç·¨è¼¯æ¨¡å¼ï¼šæ›¿æ›èˆŠçš„ subItem
                    const index = subItems.findIndex(item => item.id === editingSubItem.value.id);
                    if (index !== -1) {
                        subItems[index] = itemToSave;
                        alert(`å­é …ç›® [${itemToSave.title}] å·²æ›´æ–°ï¼`);
                    }
                } else {
                    // æ–°å¢æ¨¡å¼ï¼šæ¨å…¥æ–°çš„ subItem
                    subItems.push(itemToSave);
                    alert(`å­é …ç›® [${itemToSave.title}] å·²æ–°å¢ï¼`);
                }

                isSubItemModalOpen.value = false;
            };
            
            const deleteSubItem = () => {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤å­é …ç›® [${editingSubItem.value.title}] å—ï¼Ÿé€™å°‡ç„¡æ³•æ¢å¾©ï¼`)) {
                    return;
                }
                
                const courseIndex = courses.findIndex(c => c.id === activeCourse.value);
                if (courseIndex === -1) return;

                const subItems = courses[courseIndex].subItems;
                const index = subItems.findIndex(item => item.id === editingSubItem.value.id);

                if (index !== -1) {
                    subItems.splice(index, 1);
                    // æ¸…é™¤èˆ‡æ­¤ subItem ç›¸é—œçš„æ’ç¨‹ï¼ˆç°¡åŒ–è™•ç†ï¼šä¸æ¸…é™¤ï¼Œå› ç‚ºæ’ç¨‹ä»æœ‰åƒ¹å€¼ï¼Œä½†è­¦å‘Šä½¿ç”¨è€…ï¼‰
                    alert(`å­é …ç›® [${editingSubItem.value.title}] å·²åˆªé™¤ã€‚è«‹æ³¨æ„ï¼Œå·²å­˜åœ¨çš„è¡Œäº‹æ›†æ’ç¨‹ä»ä¿ç•™ã€‚`);
                }
                
                isSubItemModalOpen.value = false;
            };


            // åŒ¯å‡ºèª²ç¨‹æ•¸æ“š (JSON)
            const exportCoursesJson = () => {
                // å°å‡º courses é™£åˆ—
                const dataStr = JSON.stringify(courses, null, 2);
                
                let dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                let exportFileDefaultName = 'courses_data_latest.json';

                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                document.body.appendChild(linkElement); // éœ€è¦æ·»åŠ åˆ° document.body æ‰èƒ½è§¸ç™¼é»æ“Š
                linkElement.click();
                document.body.removeChild(linkElement);
                
                alert('å·²å°‡æœ€æ–°èª²ç¨‹æ•¸æ“š (JSON) åŒ¯å‡ºï¼è«‹å„²å­˜æ­¤æª”æ¡ˆï¼Œä»¥ä¾¿ä¸‹æ¬¡æä¾›çµ¦æˆ‘é€²è¡Œç¨‹å¼ç¢¼ä¿®æ”¹ã€‚');
            };


            return {
                courses,
                activeCourse,
                currentCourse,
                currentMonthDisplay,
                changeMonth,
                daysInMonth,
                scheduledItems,
                statusColor,
                isScheduleModalOpen,
                schedulingItem,
                scheduleDate,
                scheduleEventTitle,
                openScheduleModal,
                scheduleActivity,
                isRecordModalOpen,
                recordingItem,
                recordingDate,
                openRecordModal,
                saveRecord,
                deleteSchedule, 
                handleDrop,
                exportToCSV,
                courseScheduleCounts, 
                scheduleRecurrence,
                editCourseName,
                exportCoursesJson,
                // æ–°å¢å­é …ç›®åŠŸèƒ½
                isSubItemModalOpen,
                editingSubItem,
                editingSubItemEventsText,
                openSubItemModal,
                saveSubItem,
                deleteSubItem,
            }
        }
    }).mount('#app')
</script>

</body>
</html>
